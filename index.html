<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CodeDeck</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/atom-one-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/javascript.min.js"></script>
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bg: #1e1e2e;
  --sidebar-bg: #181825;
  --editor-bg: #1e1e2e;
  --breadcrumb-bg: #181825;
  --text: #cdd6f4;
  --text-dim: #6c7086;
  --accent: #89b4fa;
  --selected-bg: rgba(137, 180, 250, 0.1);
  --highlight-bg: rgba(137, 180, 250, 0.08);
  --highlight-border: #89b4fa;
  --line-number: #585b70;
  --separator: #313244;
  --folder-color: #f9e2af;
  --file-color: #cdd6f4;
  --font-mono: 'JetBrains Mono', 'Fira Code', 'Cascadia Code', 'Consolas', monospace;
}

html, body {
  height: 100%;
  overflow: hidden;
  background: var(--bg);
  color: var(--text);
  font-family: var(--font-mono);
  font-size: 24px;
}

.container {
  display: flex;
  height: 100vh;
}

.sidebar {
  width: 460px;
  min-width: 460px;
  background: var(--sidebar-bg);
  border-right: 1px solid var(--separator);
  overflow-y: auto;
  padding: 20px 0;
}

.tree-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 6px 20px;
  cursor: default;
  white-space: nowrap;
  font-size: 22px;
  line-height: 40px;
  color: var(--file-color);
}

.tree-item.selected {
  background: var(--selected-bg);
  color: var(--accent);
}

.tree-item.folder {
  color: var(--folder-color);
}

.tree-icon {
  flex-shrink: 0;
  width: 28px;
  text-align: center;
  font-size: 20px;
}

.tree-label {
  overflow: hidden;
  text-overflow: ellipsis;
}

.editor {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-width: 0;
  background: var(--editor-bg);
}

.breadcrumb {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 14px 28px;
  background: var(--breadcrumb-bg);
  border-bottom: 1px solid var(--separator);
  font-size: 20px;
  color: var(--text-dim);
  flex-shrink: 0;
}

.breadcrumb-segment {
  color: var(--text-dim);
}

.breadcrumb-segment:last-child {
  color: var(--text);
}

.breadcrumb-sep {
  color: var(--text-dim);
  opacity: 0.5;
}

.code-view {
  flex: 1;
  overflow: auto;
  padding: 14px 0;
  scrollbar-width: none;
}
.code-view::-webkit-scrollbar {
  display: none;
}

.line {
  display: flex;
  line-height: 40px;
  min-height: 40px;
}

.line.highlighted {
  background: var(--highlight-bg);
  box-shadow: inset 5px 0 0 var(--highlight-border);
}

.line-number {
  flex-shrink: 0;
  width: 100px;
  padding-right: 28px;
  text-align: right;
  color: var(--line-number);
  user-select: none;
  font-size: 22px;
}

.line.highlighted .line-number {
  color: var(--accent);
}

.line-content {
  flex: 1;
  min-width: 0;
  padding-right: 28px;
  white-space: pre;
  tab-size: 2;
  font-size: 22px;
}
</style>
</head>
<body>
<div class="container">
  <div class="sidebar" id="sidebar"></div>
  <div class="editor">
    <div class="breadcrumb" id="breadcrumb"></div>
    <div class="code-view" id="code-view"></div>
  </div>
</div>

<script src="frames.js"></script>
<script>
let currentFrame = 0;
const _urlFrame = parseInt(new URLSearchParams(location.search).get("frame"), 10);
if (!isNaN(_urlFrame)) {
  currentFrame = Math.max(0, Math.min(_urlFrame, FRAMES.length - 1));
}

function escapeHtml(text) {
  return text
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;");
}

function highlightCode(content, language) {
  if (typeof hljs !== "undefined" && hljs.getLanguage(language)) {
    const result = hljs.highlight(content, { language });
    return splitHighlightedLines(result.value);
  }
  return escapeHtml(content).split("\n");
}

function splitHighlightedLines(html) {
  const lines = html.split("\n");
  let openSpans = [];
  return lines.map(line => {
    const prefix = openSpans.join("");
    const tagRegex = /<\/span>|<span[^>]*>/g;
    let match;
    while ((match = tagRegex.exec(line)) !== null) {
      if (match[0] === "</span>") {
        openSpans.pop();
      } else {
        openSpans.push(match[0]);
      }
    }
    const suffix = "</span>".repeat(openSpans.length);
    return prefix + line + suffix;
  });
}

function renderTree(tree, selectedFile) {
  const sidebar = document.getElementById("sidebar");
  sidebar.innerHTML = tree.map(item => {
    const depth = item.path.split("/").length - 1;
    const name = item.path.split("/").pop();
    const isSelected = item.path === selectedFile;
    const isFolder = item.type === "folder";

    const classes = ["tree-item"];
    if (isSelected) classes.push("selected");
    if (isFolder) classes.push("folder");

    const icon = isFolder ? "▸" : "·";
    const indent = depth * 16;

    return `<div class="${classes.join(" ")}" style="padding-left: ${12 + indent}px">` +
      `<span class="tree-icon">${icon}</span>` +
      `<span class="tree-label">${name}</span>` +
      `</div>`;
  }).join("");
}

function renderBreadcrumb(filePath) {
  const breadcrumb = document.getElementById("breadcrumb");
  const segments = filePath.split("/");
  breadcrumb.innerHTML = segments.map((seg, i) =>
    `<span class="breadcrumb-segment">${seg}</span>` +
    (i < segments.length - 1 ? `<span class="breadcrumb-sep">›</span>` : "")
  ).join("");
}

function renderCode(content, language, highlights, scrollLine) {
  const codeView = document.getElementById("code-view");
  const lines = highlightCode(content, language);
  const highlightSet = new Set(highlights);

  codeView.innerHTML = lines.map((html, i) => {
    const lineNum = i + 1;
    const isHighlighted = highlightSet.has(lineNum);
    return `<div class="line${isHighlighted ? " highlighted" : ""}">` +
      `<span class="line-number">${lineNum}</span>` +
      `<span class="line-content">${html}</span>` +
      `</div>`;
  }).join("");

  if (scrollLine > 0) {
    const lineHeight = 40;
    const viewHeight = codeView.clientHeight;
    const scrollTop = Math.max(0, scrollLine * lineHeight - viewHeight / 3);
    codeView.scrollTop = scrollTop;
  } else {
    codeView.scrollTop = 0;
  }
}

function render() {
  const frame = FRAMES[currentFrame];
  renderTree(frame.tree, frame.selectedFile);
  renderBreadcrumb(frame.selectedFile);
  renderCode(frame.content, frame.language, frame.highlights, frame.scrollLine);
}

document.addEventListener("keydown", e => {
  if (e.key === "ArrowRight") {
    currentFrame = Math.min(currentFrame + 1, FRAMES.length - 1);
    render();
  } else if (e.key === "ArrowLeft") {
    currentFrame = Math.max(currentFrame - 1, 0);
    render();
  }
});

render();
</script>
</body>
</html>
